<html>

<head>
    <title>Flappy Bird --Chanllege Youself!</title>
    <style>
        canvas{
            display: block;
            margin: 15 auto;
            border: 0px solid rebeccapurple;
        }
        body {
            background: url("images/HBac1.jpg");
            padding-top: 40px;
        }
    </style>
    <script>
        //空间实体
        var Spacex = 0;
        var Spacey = 0;
        var Spacewidth = 384;
        var Spaceheight = 512;
        var backgroundwidth = 384;
        var backgroundheight = 448;
        var groundwidth = 18.5;
        var groundheight = 64;

        var birdwidth = 50;
        var birdheight = 60;
        var birdx = 192 - birdwidth;
        var birdy = 224 - birdheight;
        var birdvy = 0;        //鸟初始的y轴速度
        var birdimage;
        var gravity = 1;		 //重力加速度
        var jumpvelocity = 8;	 //跳跃时获得的向上速度
        var birdstate;

        var upbackground;
        var bottombackground;
        var bottomstate;
        var pipeupimage;
        var pipedownimage;
        var pipewidth = 69;
        var blankwidth = 150;
        var pipeinterval = pipewidth + 160;
        var pipenumber = 0;
        var fps = 30;
        var gamestate = 0;
        var times;
        var highscore = 0;
        var score = 0
        var movespeed = groundwidth / 4;    

        var tipimage;
        var tipwidth = 250;
        var tipheight = 228;

        var boardimage;
        var boardx;
        var boardy = 140;
        var boardwidth = 282;
        var boardheight = 245;

        var canvas;
        var Flappy;
        var i;
        var pipeheight = [];
        var Pipes = [ 	 
            [0, 0],
            [0, 0],
            [0, 0]];

        function init() {
            Flappy = document.getElementById('canvas').getContext('2d');
            Flappy.lineWidth = 2;
            Flappy.font = "bold 40px HarlemNights";
           // Flappy.fillStyle = "#FFFFFF";
            upbackground = new Image();
            upbackground.src = "images/bac.jpg";
            bottombackground = new Image();
            bottombackground.src = "images/ground.png";
            bottomstate = 1;
            birdimage = new Image();
            birdimage.src = "images/pig3.png";
            birdstate = 1;
            tipimage = new Image();
            tipimage.src = "images/space_tip.png";
            boardimage = new Image();
            boardimage.src = "images/scoreboard.png";
            boardx = (backgroundwidth - boardwidth) / 2;
            pipeupimage = new Image();
            pipeupimage.src = "images/pipeup.png";
            pipedownimage = new Image();
            pipedownimage.src = "images/pipedown.png";
            times = Math.ceil(Spacewidth / groundwidth) + 1;
            initPipe();
            DrawBegin();
            canvas = document.getElementById("canvas");
            canvas.addEventListener("mousedown", mouseDown, false);
            window.addEventListener("keydown", keyDown, false);
            setInterval(work, 1000 / fps);
        }

        function initPipe() {
            for (i = 0; i < 200; i++)
                pipeheight[i] = Math.ceil(Math.random() * 216) + 56;
            for (i = 0; i < 3; i++) {
                Pipes[i][0] = Spacewidth + i * pipeinterval;
                Pipes[i][1] = pipeheight[pipenumber];
                pipenumber++;
            }
        }

        //游戏的主要逻辑及绘制
        function work() {
            //游戏未开始
            if (gamestate == 0) {
                DrawBegin();
                DrawBird();
                DrawIns();
            }
            //游戏进行中
            if (gamestate == 1) {
                birdvy = birdvy + gravity;
                DrawScene();
                DrawBird();
                DrawScore();
                CheckCollison();		//检测碰撞
            }
            //游戏结束
            if (gamestate == 2) {
                if (birdy + birdheight < backgroundheight)	//如果鸟没有落地
                    birdvy = birdvy + gravity;
                else birdvy = 0;
                DrawEnd();
                DrawBird();
                DrawFinalScore();
                //Flappy.fillRect(boardx+14,boardy+boardheight-40,75,40); // 测试重新开始按钮的位置
            }
        }

        function DrawIns() {
            Flappy.drawImage(tipimage, birdx - 57, birdy + birdheight + 10, tipwidth, tipheight);
        }
        //绘制分数板
        function DrawFinalScore() {
            //绘制分数板
            Flappy.drawImage(boardimage, boardx, boardy, boardwidth, boardheight);
            //绘制当前的得分
            Flappy.fillText(score, boardx + 140, boardheight / 2 + boardy - 8);
            //绘制最高分
            Flappy.fillText(highscore, boardx + 140, boardheight / 2 + boardy + 44);
        }
        //绘制开始场景(不包括管道)
        function DrawBegin() {
            //清理画布上上一桢的画面
            Flappy.clearRect(Spacex, Spacey, Spacewidth, Spaceheight);
            //绘制上方静态背景
          //  Flappy.drawImage(upbackground, 0, 0, backgroundwidth, backgroundheight);
            //绘制下方的动态背景
            DrawGround();
            //绘制边框线
           // Flappy.strokeRect(Spacex + 1, Spacey + 1, Spacewidth - 2, Spaceheight - 2);
        }

        //绘制场景
        function DrawScene() {
            //清理画布上上一桢的画面
            Flappy.clearRect(Spacex, Spacey, Spacewidth, Spaceheight);
            DrawGround();
            //绘制管道
            drawAllPipe();
            //Flappy.strokeRect(Spacex + 1, Spacey + 1, Spacewidth - 2, Spaceheight - 2);
        }

        //绘制结束场景(不包括管道)
        function DrawEnd() {
            Flappy.clearRect(Spacex, Spacey, Spacewidth, Spaceheight);
            switch (bottomstate) {
                case 1:
                    for (i = 0; i < times; i++)
                        Flappy.drawImage(bottombackground, groundwidth * (i - 0.75), backgroundheight, groundwidth, groundheight);
                    break;
                case 2:
                    for (i = 0; i < times; i++)
                        Flappy.drawImage(bottombackground, groundwidth * i, backgroundheight, groundwidth, groundheight);
                    break;
                case 3:
                    for (i = 0; i < times; i++)
                        Flappy.drawImage(bottombackground, groundwidth * (i - 0.25), backgroundheight, groundwidth, groundheight);
                    break;
                case 4:
                    for (i = 0; i < times; i++)
                        Flappy.drawImage(bottombackground, groundwidth * (i - 0.5), backgroundheight, groundwidth, groundheight);
            }
            //绘制当前的柱子
            for (i = 0; i < 3; i++)
                DrawSigPipe(Pipes[i][0], Pipes[i][1]);
            //绘制边框线
            //Flappy.strokeRect(Spacex + 1, Spacey + 1, Spacewidth - 2, Spaceheight - 2);
        }

        //绘制下方的动态背景
        function DrawGround() {
            if (bottomstate == 1) {
                for (i = 0; i < times; i++)
                    Flappy.drawImage(bottombackground, groundwidth * i, backgroundheight, groundwidth, groundheight);
                bottomstate = 2;
            }
            else if (bottomstate == 2) {
                for (i = 0; i < times; i++)
                    Flappy.drawImage(bottombackground, groundwidth * (i -0.25), backgroundheight, groundwidth, groundheight);
                bottomstate = 3;
            }
            else if (bottomstate == 3) {
                for (i = 0; i < times; i++)
                    Flappy.drawImage(bottombackground, groundwidth * (i - 0.5), backgroundheight, groundwidth, groundheight);
                bottomstate = 4;
            }
            else if (bottomstate == 4) {
                for (i = 0; i < times; i++)
                    Flappy.drawImage(bottombackground, groundwidth * (i - 0.75), backgroundheight, groundwidth, groundheight);
                bottomstate = 1;
            }
        }

        //使用给定的高度和位置绘制上下两根管道
        function DrawSigPipe(location, height) {
            //绘制下面的管道
            Flappy.drawImage(pipeupimage, 0, 0, pipewidth * 2, height * 2, location, Spaceheight - (height + groundheight), pipewidth, height);
            Flappy.drawImage(pipedownimage, 0, 793 - (backgroundheight - height - blankwidth) * 2, pipewidth * 2, (backgroundheight - height - blankwidth) * 2, location, 0, pipewidth, backgroundheight - height - blankwidth);
            //Flappy.drawImage(pipedownimage,0,793-(backgroundheight-height-blankwidth)*2,pipewidth*2,(backgroundheight-height-blankwidth)*2,location,0,pipewidth,222);
        }

        //绘制需要显示的管道
        function drawAllPipe() {
            for (i = 0; i < 3; i++) {
                Pipes[i][0] = Pipes[i][0] - movespeed;
            }
            if (Pipes[0][0] <= -pipewidth) {
                Pipes[0][0] = Pipes[1][0];
                Pipes[0][1] = Pipes[1][1];
                Pipes[1][0] = Pipes[2][0];
                Pipes[1][1] = Pipes[2][1];
                Pipes[2][0] = Pipes[2][0] + pipeinterval;
                Pipes[2][1] = pipeheight[pipenumber];
                pipenumber++;
            }
            for (i = 0; i < 3; i++) {
                DrawSigPipe(Pipes[i][0], Pipes[i][1]);
            }
        }

        function DrawBird() {
            birdy = birdy + birdvy;
            Flappy.drawImage(birdimage, 0, 0,40, 44, birdx, birdy, birdwidth, birdheight);
           /* if (birdstate == 1 || birdstate == 2 || birdstate == 3) {
                Flappy.drawImage(birdimage, 0, 0, 92, 64, birdx, birdy, birdwidth, birdheight);
                birdstate++;
            }
            else if (birdstate == 4 || birdstate == 5 || birdstate == 6) {
                Flappy.drawImage(birdimage, 92, 0, 92, 64, birdx, birdy, birdwidth, birdheight);
                birdstate++;
            }
            else if (birdstate == 7 || birdstate == 8 || birdstate == 9) {
                Flappy.drawImage(birdimage, 184, 0, 92, 64, birdx, birdy, birdwidth, birdheight);
                birdstate++;
                if (birdstate == 9) birdstate = 1;
            }*/
            //context.drawImage(img,0,0,swidth,sheight,x,y,width,height);
        }

        function DrawScore() {
            Flappy.fillText(score, Spacewidth / 2 - 2, 120);
        }

        function CheckCollison() {
            //先判断第一组管道
            //如果鸟在x轴上与第一组管道重合
            if (birdx + birdwidth > Pipes[0][0] && birdx + birdwidth < Pipes[0][0] + pipewidth + birdwidth) {
                //如果鸟在y轴上与第一组管道上部或下部重合
                if (birdy < backgroundheight - Pipes[0][1] - blankwidth || birdy + birdheight > backgroundheight - Pipes[0][1]) {
                    Flappy.font = "bold 35px HarlemNights";
                    Flappy.fillStyle = "#000000";
                    if (score > highscore)
                        highscore = score;
                    gamestate = 2;	//游戏结束
                }
            }
            //判断第二组管道
            //如果鸟在x轴上与第二组管道重合
            //这里我原本使用else if出现了问题，但第一版中却没有问题，对比代码后发现原因是上方第一个if后没有加大括号，
            //这里的else无法区分对应哪一个if，加上大括号后问题解决，建议将if后的内容都加上大括号，养成良好的变成习惯
            else if (birdx + birdwidth > Pipes[1][0] && birdx + birdwidth < Pipes[1][0] + pipewidth + birdwidth) {
                //如果鸟在y轴上与第二组管道上部或下部重合
                if (birdy < backgroundheight - Pipes[1][1] - blankwidth || birdy + birdheight > backgroundheight - Pipes[1][1]) {
                    Flappy.font = "bold 35px HarlemNights";
                    Flappy.fillStyle = "#000000";
                    if (score > highscore)
                        highscore = score;
                    gamestate = 2;	//游戏结束
                }
            }
            //判断是否碰撞地面
            else if (birdy + birdheight > backgroundheight) {
                Flappy.font = "bold 35px HarlemNights";
                Flappy.fillStyle = "#000000";
                if (score > highscore)
                    highscore = score;
                gamestate = 2;	//游戏结束
            }
            //通过了一根管道加一分
            if (birdx > Pipes[0][0] + pipewidth - movespeed / 2 && birdx < Pipes[0][0] + pipewidth + movespeed / 2) {
                score++;
            }
        }


        //处理键盘事件
        function keyDown(evt) {
            evt = (evt) ? evt : ((window.event) ? window.event : "");
            var key = evt.keyCode ? evt.keyCode : evt.which;
            if (gamestate == 0) {
                if (key == 83) {
                    gamestate = 1;
                }
            }
            else if (gamestate == 1) {
                if(key==32)
                birdvy = -jumpvelocity;
            }
            else if (gamestate == 2) {
                if(key==82)
                {
                    restart();
                }
            }
        }

        //处理鼠标点击事件，相比键盘多了位置判断
        function mouseDown(ev) {
            var mx;			//存储鼠标横坐标
            var my;			//存储鼠标纵坐标
            if (ev.layerX || ev.layerX == 0) { // Firefox
                mx = ev.layerX;
                my = ev.layerY;
            } else if (ev.offsetX || ev.offsetX == 0) { //IE
                mx = ev.offsetX;
                my = ev.offsetY;
            }
            if (gamestate == 0) {
                birdvy = -jumpvelocity;
                gamestate = 1;
            }
            else if (gamestate == 1) {
                birdvy = -jumpvelocity;
            }
            //游戏结束后判断是否点击了重新开始
            else if (gamestate == 2) {
                //Flappy.fillRect(boardx+14,boardy+boardheight-40,75,40); 
                restart();
            }
        }

        function restart() {
            gamestate = 0;
            Flappy.font = "bold 40px HarlemNights";
            Flappy.fillStyle = "#FFFFFF";
            score = 0;
            pipenumber = 0;
            initPipe();
            birdx = 192 - birdwidth;
            birdy = 224 - birdheight;
            birdvy = 0;
        }

    </script>
</head>

<body onLoad="init();">
    <canvas id="canvas" width="384" height="512" style="margin-top: 0px;">
    </canvas>
</body>

</html>